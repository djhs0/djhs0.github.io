<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>使用windows API控制另一个程序 | DJHS0</title>
    <meta name="description" content="djhs0 start.">
    <link rel="icon" href="/favicon.ico">
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    
    <link rel="preload" href="/assets/css/0.styles.719cd97d.css" as="style"><link rel="preload" href="/assets/js/app.0a93343e.js" as="script"><link rel="preload" href="/assets/js/4.66501a8b.js" as="script"><link rel="preload" href="/assets/js/1.50fe1130.js" as="script"><link rel="preload" href="/assets/js/20.a1512aa5.js" as="script"><link rel="prefetch" href="/assets/js/10.044e1b06.js"><link rel="prefetch" href="/assets/js/11.184e4e09.js"><link rel="prefetch" href="/assets/js/12.f6b4c6f5.js"><link rel="prefetch" href="/assets/js/13.5b384cb8.js"><link rel="prefetch" href="/assets/js/14.ecc4519e.js"><link rel="prefetch" href="/assets/js/15.c93a5171.js"><link rel="prefetch" href="/assets/js/16.a7f287c6.js"><link rel="prefetch" href="/assets/js/17.e8bc4249.js"><link rel="prefetch" href="/assets/js/18.567a89f7.js"><link rel="prefetch" href="/assets/js/19.ccf691b2.js"><link rel="prefetch" href="/assets/js/21.35361fa7.js"><link rel="prefetch" href="/assets/js/5.5b2f1be9.js"><link rel="prefetch" href="/assets/js/6.2a634ec8.js"><link rel="prefetch" href="/assets/js/7.fb26297b.js"><link rel="prefetch" href="/assets/js/8.079ba8c4.js"><link rel="prefetch" href="/assets/js/9.36cbb02c.js"><link rel="prefetch" href="/assets/js/vendors~flowchart.cd2faf37.js">
    <link rel="stylesheet" href="/assets/css/0.styles.719cd97d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div><div class="theme-container"><div><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/head.png" alt="DJHS0" class="logo"> <span class="site-name">DJHS0</span></a> <div class="links"><div class="color-picker"><a href="#" class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="theme-options"><!----> <div class="dark-theme-options toggle-option"><label for="dark-theme-toggle">Enable Dark Theme?</label> <input id="dark-theme-toggle" type="checkbox" checked="checked"></div></div></div></div> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      Category
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/category/django.html" class="nav-link"><i class="iconfont undefined"></i>
  django
</a></li><li class="dropdown-item"><!----> <a href="/category/旧笔记搬运.html" class="nav-link"><i class="iconfont undefined"></i>
  旧笔记搬运
</a></li><li class="dropdown-item"><!----> <a href="/category/python.html" class="nav-link"><i class="iconfont undefined"></i>
  python
</a></li><li class="dropdown-item"><!----> <a href="/category/windows.html" class="nav-link"><i class="iconfont undefined"></i>
  windows
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><a href="/timeLine/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      Contact
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/dongdawang" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      Category
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/category/django.html" class="nav-link"><i class="iconfont undefined"></i>
  django
</a></li><li class="dropdown-item"><!----> <a href="/category/旧笔记搬运.html" class="nav-link"><i class="iconfont undefined"></i>
  旧笔记搬运
</a></li><li class="dropdown-item"><!----> <a href="/category/python.html" class="nav-link"><i class="iconfont undefined"></i>
  python
</a></li><li class="dropdown-item"><!----> <a href="/category/windows.html" class="nav-link"><i class="iconfont undefined"></i>
  windows
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><a href="/timeLine/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      Contact
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/dongdawang" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>使用windows API控制另一个程序</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/views/2019/windows/2018-06-28-WindowsAPI%E4%BD%BF%E7%94%A8.html#隔空点击button" class="sidebar-link">隔空点击button</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/views/2019/windows/2018-06-28-WindowsAPI%E4%BD%BF%E7%94%A8.html#隔空点击menu-toolbar" class="sidebar-link">隔空点击~~menu~~ toolbar</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/views/2019/windows/2018-06-28-WindowsAPI%E4%BD%BF%E7%94%A8.html#隔空获取另一个程序中textbox中的内容" class="sidebar-link">隔空获取另一个程序中textbox中的内容</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/views/2019/windows/2018-06-28-WindowsAPI%E4%BD%BF%E7%94%A8.html#总结" class="sidebar-link">总结</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <div><main class="page reco-hide"> <div class="page-title"><h1>使用windows API控制另一个程序</h1> <hr> <div data-v-0b496ca7><i class="iconfont reco-account" data-v-0b496ca7><span data-v-0b496ca7>djhs0</span></i> <i class="iconfont reco-date" data-v-0b496ca7><span data-v-0b496ca7>2018-6-28</span></i> <span id="/views/2019/windows/2018-06-28-WindowsAPI%E4%BD%BF%E7%94%A8.html" data-flag-title="Your Article Title" class="leancloud-visitors" data-v-2e99e05a data-v-0b496ca7><i class="iconfont reco-eye" style="margin-right: .5rem" data-v-2e99e05a></i> <a class="leancloud-visitors-count" style="font-size:.9rem;font-weight:normal;color:#999;" data-v-2e99e05a></a></span> <i class="iconfont reco-tag tags" data-v-0b496ca7><span class="tag-item" data-v-0b496ca7>
      api
    </span><span class="tag-item" data-v-0b496ca7>
      c#
    </span><span class="tag-item" data-v-0b496ca7>
      WMI
    </span></i></div></div> <div class="content__default"><h1 id="使用windows-api控制另一个程序"><a href="#使用windows-api控制另一个程序" aria-hidden="true" class="header-anchor">#</a> 使用windows API控制另一个程序</h1> <h2 id="隔空点击button"><a href="#隔空点击button" aria-hidden="true" class="header-anchor">#</a> 隔空点击button</h2> <p>通过window的API来点击一个独立的应用程序中的button。</p> <p>自己编写一个显示的APP, 然后编写一个目标APP，然后去控制目标APP中button的点击。</p> <p>在开始之前可以了解到的是window的桌面应用都是通过消息赖传递控制的，MFC实际上是构建在windowAPI之前的，winform可能有些不一样。</p> <p>那么是否可以通过windowAPI来控制MFC写的应用程序，获取符合window标准的应用程序呢？</p> <p>是的，可以。</p> <p>主要通过以下3个函数来控制</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">const</span> <span class="token keyword">int</span> WM_CLICK <span class="token operator">=</span> <span class="token number">0x00F5</span><span class="token punctuation">;</span><span class="token comment">//鼠标点击消息，各种消息的数值，可以参考MSDN</span>
<span class="token comment">//获取主窗体的句柄</span>
<span class="token class-name">IntPtr</span> hwndTest <span class="token operator">=</span> <span class="token function">FindWindow</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> lpszName_Test<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//获取子窗体上button的句柄</span>
hwndbtnShow <span class="token operator">=</span> <span class="token function">FindWindowEx</span><span class="token punctuation">(</span>hwndTest<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> lpszName_btnShow<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">SendMessage</span><span class="token punctuation">(</span>hwndbtnShow<span class="token punctuation">,</span> WM_CLICK<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>上面3个函数主要实现的功能就是，</p> <p><code>FindWindow(null, window_title)</code> ，第一个参数为窗体的类名，第二个参数是窗体的标题，通过其中任意一个都可以找到窗体的句柄，然后根据主窗体的句柄，通过<code>FindWindowEx(main_handle, 0, null, child_window_title)</code>函数找到子窗口的句柄，这个子窗体一般就是button本身了，然后使用<code>SendMessage</code>函数向button发送WM_CLICK消息，之后buuton就会被点击一下了。</p> <p>上面3个函数的具体使用情况可以参照MSDN上函数的定义，或者下一个windowAPI手册，都很方便的查到。值得说的一点是windowAPI是基于c++的，所以c#调用的时候会发现函数中需要的参数类型和返回值得类型和c#的不一样，这点需要查找资料找到c#和c++中类型的对应关系。</p> <p>了解到上面的一些信息之后会发现窗体的类名，窗体的标题这些东西从哪里获得的呢？</p> <p>这就需要window提供的一个工具<code>spy++</code>，这个工具在安装visual studio 的c++会提供，不过它是一个独立的程序，不依靠visual studio也可以运行，下载下来即可。</p> <p><img src="/winapi/%E7%AA%97%E5%8F%A3.PNG" alt="窗口"></p> <p>具体的spy++使用方法可以很容易的查到，可以看到上图中找到了对应的两个窗体，在spy++中右键两个窗体，可以找到窗体的标题和类名。</p> <p>然后就是编写代码了，具体代码如下</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token punctuation">[</span><span class="token class-name">DllImport</span><span class="token punctuation">(</span><span class="token string">&quot;user32.dll&quot;</span><span class="token punctuation">,</span> EntryPoint <span class="token operator">=</span> <span class="token string">&quot;FindWindow&quot;</span><span class="token punctuation">,</span> SetLastError <span class="token operator">=</span> <span class="token keyword">true</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">extern</span> <span class="token class-name">IntPtr</span> <span class="token function">FindWindow</span><span class="token punctuation">(</span><span class="token keyword">string</span> lpClassName<span class="token punctuation">,</span> <span class="token keyword">string</span> lpWindowName<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">[</span><span class="token class-name">DllImport</span><span class="token punctuation">(</span><span class="token string">&quot;user32.dll&quot;</span><span class="token punctuation">,</span> EntryPoint <span class="token operator">=</span> <span class="token string">&quot;FindWindowEx&quot;</span><span class="token punctuation">,</span> SetLastError <span class="token operator">=</span> <span class="token keyword">true</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">extern</span> <span class="token class-name">IntPtr</span> <span class="token function">FindWindowEx</span><span class="token punctuation">(</span><span class="token class-name">IntPtr</span> hwndParent<span class="token punctuation">,</span> <span class="token keyword">uint</span> hwndChildAfter<span class="token punctuation">,</span> <span class="token keyword">string</span> lpszClass<span class="token punctuation">,</span> <span class="token keyword">string</span> lpszWindow<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">[</span><span class="token class-name">DllImport</span><span class="token punctuation">(</span><span class="token string">&quot;user32.dll&quot;</span><span class="token punctuation">,</span> EntryPoint <span class="token operator">=</span> <span class="token string">&quot;SendMessage&quot;</span><span class="token punctuation">,</span> SetLastError <span class="token operator">=</span> <span class="token keyword">true</span><span class="token punctuation">,</span> CharSet <span class="token operator">=</span> CharSet<span class="token punctuation">.</span>Auto<span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">extern</span> <span class="token keyword">int</span> <span class="token function">SendMessage</span><span class="token punctuation">(</span><span class="token class-name">IntPtr</span> hwnd<span class="token punctuation">,</span> <span class="token keyword">uint</span> wMsg<span class="token punctuation">,</span> <span class="token keyword">int</span> wParam<span class="token punctuation">,</span> <span class="token keyword">int</span> lParam<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token keyword">int</span> WM_CLICK <span class="token operator">=</span> <span class="token number">0x00F5</span><span class="token punctuation">;</span><span class="token comment">//鼠标点击消息，各种消息的数值，可以参考MSDN  </span>

<span class="token keyword">string</span> main_title <span class="token operator">=</span> <span class="token string">&quot;AppControl&quot;</span><span class="token punctuation">;</span><span class="token comment">//主窗体的标题  </span>
<span class="token keyword">string</span> child_title <span class="token operator">=</span> <span class="token string">&quot;One&quot;</span><span class="token punctuation">;</span><span class="token comment">//主窗体上button的标题  </span>

<span class="token class-name">IntPtr</span> main_handle <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IntPtr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//主窗体的句柄  </span>
<span class="token class-name">IntPtr</span> child_handle <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IntPtr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//主窗体上button的句柄  </span>

main_handle <span class="token operator">=</span> <span class="token function">FindWindow</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> main_title<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获取主窗体的句柄  </span>
child_handle <span class="token operator">=</span> <span class="token function">FindWindowEx</span><span class="token punctuation">(</span>main_handle<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> child_title<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获取主窗体上button的句柄  </span>
<span class="token function">SendMessage</span><span class="token punctuation">(</span>child_handle<span class="token punctuation">,</span> WM_CLICK<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//给主窗体上button发送鼠标点击消息</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>具体效果：</p> <p><img src="/winapi/click.PNG" alt="click"></p> <p>点击右边的one然后左边的程序的<code>one</code>button被点击了。</p> <p>OK, 现在我们实现了隔空点击另一个程序的button。</p> <h2 id="隔空点击menu-toolbar"><a href="#隔空点击menu-toolbar" aria-hidden="true" class="header-anchor">#</a> 隔空点击<s>menu</s> toolbar</h2> <p>做到这里之后，似乎所有的操作都能使用这种获得窗体句柄，然后发送消息的形式实现。实际上是不行的，在我实现点击菜单栏中button的过程中遇到了奇怪的现象，如下</p> <p><img src="/winapi/STVP.PNG" alt="STVP"></p> <p>上图是烧录软件<code>ST Visual Programmer</code>的界面，可以看到红框中的<strong>好像</strong>两个菜单栏的东西，实际上他们不是菜单栏，通过使用spy++查看，可以看到这两个东西各自是一个窗体，当时一直使用的是操作菜单栏的方式去控制他们，当然是失败了。</p> <p>那么真正的菜单栏是什么样子的呢？可以通过查看一个广泛使用的编辑器notepad++来说明， 打开spy++和notepad++。</p> <p><img src="/winapi/notepad.PNG" alt="notepad"></p> <p>在上图中红色框中的是菜单栏，可以在右边的主窗体属性检查中看到菜单句柄，如果主窗体存在菜单栏，那么主窗体的属性检查中一定会有菜单句柄，如果菜单句柄为0，那么久表示这个主窗体没有菜单栏。</p> <p>那么绿色框中的又是什么呢？我也不确定，在winform中这种组件叫做menustrip，在MFC中应该叫做toolbar。</p> <p>好吧，现在终于确定我们要操作的目标组件到底是什么了，终于要达成目标了，且慢，一个大坑即将来到，在使用spy++获取这种toolbar(姑且叫它toolbar)组件信息的时候发现它就只是一个窗体，其下一级无法找到一个具体的button，那么怎么点击呢？这样上面点击button的方法就不能使用了。</p> <p>如果要解释上面的现象，就要知道window中存在着主窗体，子窗体，下一级还存在着控件。</p> <p>为了点击toolbar中疑似button的控件，就需要使用</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token comment">/// &lt;summary&gt;</span>
<span class="token comment">/// 向窗体中指定的控件发送消息</span>
<span class="token comment">/// &lt;/summary&gt;</span>
<span class="token comment">/// &lt;param name=&quot;handle&quot;&gt;窗体句柄&lt;/param&gt;</span>
<span class="token comment">/// &lt;param name=&quot;WM_COMMAND&quot;&gt;windows消息&lt;/param&gt;</span>
<span class="token comment">/// &lt;param name=&quot;ctrlID&quot;&gt;控件ID&lt;/param&gt;</span>
<span class="token comment">/// &lt;param name=&quot;0&quot;&gt;缺省&lt;/param&gt;</span>
<span class="token function">PostMessage</span><span class="token punctuation">(</span>handle<span class="token punctuation">,</span> WM_COMMAND<span class="token punctuation">,</span> ctrlID<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>所以即使toolbar中有很多疑似button的控件，我们也能使用控件ID来找到他们。那么关键的信息ctrlID控件ID怎么获得呢，spy++能获取到控件ID，但是它只能获取到窗体的控件ID，对于toolbar不起作用，现在就需要使用另外一种神奇的工具<code>eXeScope</code>，这个工具普遍应用于汉化中，在这里，它可以获取到toolbar中控件的ID。使用eXeScope打开指定程序的exe。</p> <p><img src="/winapi/scope.PNG" alt="scope"></p> <p>在上图中可以看到<code>32807</code>是控件ID，<code>Verify current</code>是控件的描述，这样我们就找到了控件的ID，然后就可以点击它了，下面是code:</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">extern</span> <span class="token class-name">IntPtr</span> <span class="token function">PostMessage</span><span class="token punctuation">(</span><span class="token class-name">IntPtr</span> hWnd<span class="token punctuation">,</span> <span class="token keyword">uint</span> msg<span class="token punctuation">,</span> <span class="token keyword">int</span> wParam<span class="token punctuation">,</span> <span class="token keyword">int</span> lParam<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">[</span><span class="token class-name">DllImport</span><span class="token punctuation">(</span><span class="token string">&quot;user32.dll&quot;</span><span class="token punctuation">,</span> EntryPoint <span class="token operator">=</span> <span class="token string">&quot;SetForegroundWindow&quot;</span><span class="token punctuation">,</span> SetLastError <span class="token operator">=</span> <span class="token keyword">true</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

<span class="token keyword">const</span> <span class="token keyword">int</span> WM_COMMAND <span class="token operator">=</span> <span class="token number">0x111</span><span class="token punctuation">;</span>

<span class="token keyword">string</span> main_title <span class="token operator">=</span> <span class="token string">@&quot;no project - STVP&quot;</span><span class="token punctuation">;</span><span class="token comment">//主窗体的标题  </span>
<span class="token class-name">IntPtr</span> main_handle <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IntPtr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//主窗体的句柄</span>
<span class="token class-name">IntPtr</span> child_hanld <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IntPtr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">IntPtr</span> childchild_handle <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IntPtr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
main_handle <span class="token operator">=</span> <span class="token function">FindWindow</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> main_title<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获取主窗体的句柄</span>
child_hanld <span class="token operator">=</span> <span class="token function">FindWindowEx</span><span class="token punctuation">(</span>main_handle<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">&quot;default&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
childchild_handle <span class="token operator">=</span> <span class="token function">FindWindowEx</span><span class="token punctuation">(</span>child_hanld<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">&quot;default&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">PostMessage</span><span class="token punctuation">(</span>childchild_handle<span class="token punctuation">,</span> WM_COMMAND<span class="token punctuation">,</span> <span class="token number">32807</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>这样就实现了点击toolbar中某个控件的功能。</p> <p>好像忘记了什么？那如果想操作MENU怎么做呢？对于这项需求，window提供了可用的函数。</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token comment">// 根据主窗体句柄获取菜单句柄</span>
<span class="token punctuation">[</span><span class="token class-name">DllImport</span><span class="token punctuation">(</span><span class="token string">&quot;user32.dll&quot;</span><span class="token punctuation">,</span> EntryPoint <span class="token operator">=</span> <span class="token string">&quot;GetMenu&quot;</span><span class="token punctuation">,</span> SetLastError <span class="token operator">=</span> <span class="token keyword">true</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">extern</span> <span class="token class-name">IntPtr</span> <span class="token function">GetMenu</span><span class="token punctuation">(</span><span class="token class-name">IntPtr</span> hwnd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 根据菜单句柄获得菜单中元素的个数</span>
<span class="token punctuation">[</span><span class="token class-name">DllImport</span><span class="token punctuation">(</span><span class="token string">&quot;user32.dll&quot;</span><span class="token punctuation">,</span> EntryPoint <span class="token operator">=</span> <span class="token string">&quot;GetMenuItemCount&quot;</span><span class="token punctuation">,</span> SetLastError <span class="token operator">=</span> <span class="token keyword">true</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">extern</span> <span class="token keyword">int</span> <span class="token function">GetMenuItemCount</span><span class="token punctuation">(</span><span class="token class-name">IntPtr</span> hMenu<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 根据菜单句柄，和菜单元素位置获得子菜单句柄</span>
<span class="token punctuation">[</span><span class="token class-name">DllImport</span><span class="token punctuation">(</span><span class="token string">&quot;user32.dll&quot;</span><span class="token punctuation">,</span> EntryPoint <span class="token operator">=</span> <span class="token string">&quot;GetSubMenu&quot;</span><span class="token punctuation">,</span> SetLastError <span class="token operator">=</span> <span class="token keyword">true</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">extern</span> <span class="token class-name">IntPtr</span> <span class="token function">GetSubMenu</span><span class="token punctuation">(</span><span class="token class-name">IntPtr</span> hMenu<span class="token punctuation">,</span> <span class="token keyword">int</span> nPos<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 判断一个句柄是不是菜单句柄</span>
<span class="token punctuation">[</span><span class="token class-name">DllImport</span><span class="token punctuation">(</span><span class="token string">&quot;user32.dll&quot;</span><span class="token punctuation">,</span> EntryPoint <span class="token operator">=</span> <span class="token string">&quot;IsMenu&quot;</span><span class="token punctuation">,</span> SetLastError <span class="token operator">=</span> <span class="token keyword">true</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">extern</span> <span class="token keyword">bool</span> <span class="token function">IsMenu</span><span class="token punctuation">(</span><span class="token class-name">IntPtr</span> hMenu<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h2 id="隔空获取另一个程序中textbox中的内容"><a href="#隔空获取另一个程序中textbox中的内容" aria-hidden="true" class="header-anchor">#</a> 隔空获取另一个程序中textbox中的内容</h2> <p>根据使用spy++查看窗体元素，发现textbox实际上是一个窗体：</p> <p><img src="/winapi/text.PNG" alt="text"></p> <p>在上图中一个textbox实际上是一个窗体，那么如何获取这个窗体中的数据，或者向这个窗体中写数据呢？需要以下函数：</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token comment">// 设置text</span>
<span class="token keyword">const</span> <span class="token keyword">int</span> WM_SETTEXT <span class="token operator">=</span> <span class="token number">0x000C</span><span class="token punctuation">;</span>
<span class="token comment">// 获取text</span>
<span class="token keyword">const</span> <span class="token keyword">int</span> WM_GETTEXT <span class="token operator">=</span> <span class="token number">0x000D</span><span class="token punctuation">;</span>

<span class="token comment">/// &lt;summary&gt;</span>
<span class="token comment">/// 向窗体中指定的控件发送消息，注意这个函数和上面那个SendMessage函数不一样了，最后一个参</span>
<span class="token comment">///	数变成了StringBuilder类型</span>
<span class="token comment">/// &lt;/summary&gt;</span>
<span class="token comment">/// &lt;param name=&quot;hwnd&quot;&gt;窗体句柄&lt;/param&gt;</span>
<span class="token comment">/// &lt;param name=&quot;wMsg&quot;&gt;windows消息&lt;/param&gt;</span>
<span class="token comment">/// &lt;param name=&quot;wParam&quot;&gt;缺省&lt;/param&gt;</span>
<span class="token comment">/// &lt;param name=&quot;sb&quot;&gt;存放获取和发送text的变量&lt;/param&gt;</span>
<span class="token punctuation">[</span><span class="token class-name">DllImport</span><span class="token punctuation">(</span><span class="token string">&quot;user32.dll&quot;</span><span class="token punctuation">,</span> EntryPoint <span class="token operator">=</span> <span class="token string">&quot;SendMessage&quot;</span><span class="token punctuation">,</span> SetLastError <span class="token operator">=</span> <span class="token keyword">true</span><span class="token punctuation">,</span> CharSet <span class="token operator">=</span> CharSet<span class="token punctuation">.</span>Auto<span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">extern</span> <span class="token keyword">int</span> <span class="token function">SendMessage</span><span class="token punctuation">(</span><span class="token class-name">IntPtr</span> hwnd<span class="token punctuation">,</span> <span class="token keyword">uint</span> wMsg<span class="token punctuation">,</span> <span class="token keyword">int</span> wParam<span class="token punctuation">,</span> <span class="token class-name">StringBuilder</span> sb<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>好吧，既然已经了解到大概使用什么方法实现了那么就直接上代码了：</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">string</span> main_title <span class="token operator">=</span> <span class="token string">&quot;no project - STVP&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">string</span> child_title <span class="token operator">=</span> <span class="token string">&quot;Output Window&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">string</span> child_1_title <span class="token operator">=</span> <span class="token string">&quot;Output Window&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">string</span> child_2_classname <span class="token operator">=</span> <span class="token string">&quot;RICHEDIT&quot;</span><span class="token punctuation">;</span>

<span class="token class-name">IntPtr</span> main_handle <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IntPtr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//主窗体的句柄</span>
<span class="token class-name">IntPtr</span> child_Handle <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IntPtr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">IntPtr</span> child_1_Handle <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IntPtr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">IntPtr</span> child_2_Handle <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IntPtr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

main_handle <span class="token operator">=</span> <span class="token function">FindWindow</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> main_title<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获取主窗体的句柄</span>
childHandle <span class="token operator">=</span> <span class="token function">FindWindowEx</span><span class="token punctuation">(</span>main_handle<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> child_title<span class="token punctuation">)</span><span class="token punctuation">;</span>
child_1_Handle <span class="token operator">=</span> <span class="token function">FindWindowEx</span><span class="token punctuation">(</span>childHandle<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> child_1_title<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 下面这个主意，是使用classname来获取窗口的句柄</span>
child_2_Handle <span class="token operator">=</span> <span class="token function">FindWindowEx</span><span class="token punctuation">(</span>child_1_Handle<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> child_2_classname<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//StringBuilder text1 = new StringBuilder(&quot;testestts&quot;);</span>
<span class="token class-name">StringBuilder</span> strBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>child_2_Handle <span class="token operator">!=</span> IntPtr<span class="token punctuation">.</span>Zero<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name">Int32</span> size <span class="token operator">=</span> <span class="token function">SendMessage</span><span class="token punctuation">(</span>child_2_Handle<span class="token punctuation">,</span> MSG<span class="token punctuation">.</span>WM_GETTEXTLENGTH<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//SendMessage(child_2_Handle, WM_SETTEXT, 0, text1);</span>
    <span class="token class-name">StringBuilder</span> sb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span>size <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SendMessage</span><span class="token punctuation">(</span>child_2_Handle<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>WM_GETTEXT<span class="token punctuation">,</span> sb<span class="token punctuation">.</span>Capacity<span class="token punctuation">,</span> sb<span class="token punctuation">)</span><span class="token punctuation">;</span>
    rtx_b<span class="token punctuation">.</span><span class="token function">AppendText</span><span class="token punctuation">(</span>title<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>OK, 以上就是具体实现功能的代码了，接下来就是效果的展示了</p> <p><img src="/winapi/gettext.PNG" alt="gettext"></p> <p>可以看到的是将其他软件中的文本复制过来了。</p> <h2 id="总结"><a href="#总结" aria-hidden="true" class="header-anchor">#</a> 总结</h2> <p>通过努力，基本上实现了按钮点击，toolbar点击，文本获取的操作，但是这种方法基本上针对于某一种软件，如果一个软件使用的是自己特有的框架，或者自己有一套特殊的机制，亦或者是软件做了安全处理，屏蔽了几种windows消息，那么这种方法就不可以了(据说可以通过dll注入来解决)。</p> <p>虽然上面的解决方法不是很完美，但是基本上已经完成了要求，选择将这些记录成文主要是因为</p> <ol><li>毕竟是花费近一个星期的成果，以前一直以为这种隔空操作的方式基本上不可能。</li> <li>中间查找资料确实好麻烦，如果自己准确的知道相关的名字也不会走这么多弯路了。</li> <li>最后想联系下自己总结成文的能力，避免出现下笔无言的情况。</li></ol></div> <!----> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">7/2/2019, 11:43:53 PM</span></div></footer> <!----> </main> <div class="valine-wrapper" data-v-0162251c><div id="valine" data-v-0162251c></div></div></div> <div class="back-to-ceiling" style="right:1rem;bottom:3rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;background-color:rgba(231, 234, 241,.5);display:none;" data-v-d0bfeaa4 data-v-d0bfeaa4><i class="iconfont reco-up" data-v-d0bfeaa4></i></div></div></div></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.0a93343e.js" defer></script><script src="/assets/js/4.66501a8b.js" defer></script><script src="/assets/js/1.50fe1130.js" defer></script><script src="/assets/js/20.a1512aa5.js" defer></script>
  </body>
</html>
