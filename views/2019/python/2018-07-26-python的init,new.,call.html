<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>python中new,init,call | DJHS0</title>
    <meta name="description" content="djhs0 start.">
    <link rel="icon" href="/favicon.ico">
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    
    <link rel="preload" href="/assets/css/0.styles.719cd97d.css" as="style"><link rel="preload" href="/assets/js/app.85bff52c.js" as="script"><link rel="preload" href="/assets/js/4.9ee7c604.js" as="script"><link rel="preload" href="/assets/js/1.0b6a70ce.js" as="script"><link rel="preload" href="/assets/js/14.e6cfaa4f.js" as="script"><link rel="prefetch" href="/assets/js/10.c2dc69e0.js"><link rel="prefetch" href="/assets/js/11.6260c6f0.js"><link rel="prefetch" href="/assets/js/12.a850fae7.js"><link rel="prefetch" href="/assets/js/13.2260dda9.js"><link rel="prefetch" href="/assets/js/15.5765b091.js"><link rel="prefetch" href="/assets/js/16.b3083e66.js"><link rel="prefetch" href="/assets/js/17.6b1ac78f.js"><link rel="prefetch" href="/assets/js/18.42fa4b6d.js"><link rel="prefetch" href="/assets/js/19.512f3c00.js"><link rel="prefetch" href="/assets/js/20.26226443.js"><link rel="prefetch" href="/assets/js/21.d130ae55.js"><link rel="prefetch" href="/assets/js/22.0e1fe48d.js"><link rel="prefetch" href="/assets/js/23.89467964.js"><link rel="prefetch" href="/assets/js/5.12bd1da9.js"><link rel="prefetch" href="/assets/js/6.29bf57e7.js"><link rel="prefetch" href="/assets/js/7.e4d52014.js"><link rel="prefetch" href="/assets/js/8.22f77f9e.js"><link rel="prefetch" href="/assets/js/9.55f14ddd.js"><link rel="prefetch" href="/assets/js/vendors~flowchart.cd2faf37.js">
    <link rel="stylesheet" href="/assets/css/0.styles.719cd97d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div><div class="theme-container"><div><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/head.png" alt="DJHS0" class="logo"> <span class="site-name">DJHS0</span></a> <div class="links"><div class="color-picker"><a href="#" class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="theme-options"><!----> <div class="dark-theme-options toggle-option"><label for="dark-theme-toggle">Enable Dark Theme?</label> <input id="dark-theme-toggle" type="checkbox" checked="checked"></div></div></div></div> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      Category
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/category/django.html" class="nav-link"><i class="iconfont undefined"></i>
  django
</a></li><li class="dropdown-item"><!----> <a href="/category/旧笔记搬运.html" class="nav-link"><i class="iconfont undefined"></i>
  旧笔记搬运
</a></li><li class="dropdown-item"><!----> <a href="/category/linux.html" class="nav-link"><i class="iconfont undefined"></i>
  linux
</a></li><li class="dropdown-item"><!----> <a href="/category/python.html" class="nav-link"><i class="iconfont undefined"></i>
  python
</a></li><li class="dropdown-item"><!----> <a href="/category/windows.html" class="nav-link"><i class="iconfont undefined"></i>
  windows
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><a href="/timeLine/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      Contact
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/djhs0" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      Category
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/category/django.html" class="nav-link"><i class="iconfont undefined"></i>
  django
</a></li><li class="dropdown-item"><!----> <a href="/category/旧笔记搬运.html" class="nav-link"><i class="iconfont undefined"></i>
  旧笔记搬运
</a></li><li class="dropdown-item"><!----> <a href="/category/linux.html" class="nav-link"><i class="iconfont undefined"></i>
  linux
</a></li><li class="dropdown-item"><!----> <a href="/category/python.html" class="nav-link"><i class="iconfont undefined"></i>
  python
</a></li><li class="dropdown-item"><!----> <a href="/category/windows.html" class="nav-link"><i class="iconfont undefined"></i>
  windows
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><a href="/timeLine/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      Contact
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/djhs0" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>python中new,init,call</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/views/2019/python/2018-07-26-python%E7%9A%84init,new.,call.html#引言" class="sidebar-link">引言</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/views/2019/python/2018-07-26-python%E7%9A%84init,new.,call.html#内容" class="sidebar-link">内容</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/views/2019/python/2018-07-26-python%E7%9A%84init,new.,call.html#一、-init" class="sidebar-link">一、__init__</a></li><li class="sidebar-sub-header"><a href="/views/2019/python/2018-07-26-python%E7%9A%84init,new.,call.html#二、-new" class="sidebar-link">二、__new__</a></li><li class="sidebar-sub-header"><a href="/views/2019/python/2018-07-26-python%E7%9A%84init,new.,call.html#三、-call" class="sidebar-link">三、__call__</a></li></ul></li></ul></section></li></ul> </aside> <div><main class="page reco-hide"> <div class="page-title"><h1>python中new,init,call</h1> <hr> <div data-v-0b496ca7><i class="iconfont reco-account" data-v-0b496ca7><span data-v-0b496ca7>djhs0</span></i> <i class="iconfont reco-date" data-v-0b496ca7><span data-v-0b496ca7>2018-7-26</span></i> <span id="/views/2019/python/2018-07-26-python%E7%9A%84init,new.,call.html" data-flag-title="Your Article Title" class="leancloud-visitors" data-v-2e99e05a data-v-0b496ca7><i class="iconfont reco-eye" style="margin-right: .5rem" data-v-2e99e05a></i> <a class="leancloud-visitors-count" style="font-size:.9rem;font-weight:normal;color:#999;" data-v-2e99e05a></a></span> <i class="iconfont reco-tag tags" data-v-0b496ca7><span class="tag-item" data-v-0b496ca7>
      new
    </span><span class="tag-item" data-v-0b496ca7>
      init
    </span><span class="tag-item" data-v-0b496ca7>
      call
    </span></i></div></div> <div class="content__default"><h1 id="python中new-init-call"><a href="#python中new-init-call" aria-hidden="true" class="header-anchor">#</a> python中new,init,call</h1> <h2 id="引言"><a href="#引言" aria-hidden="true" class="header-anchor">#</a> 引言</h2> <p>​	在学习python的时候，类是python的重要组成部分。在使用python类的时候，总会遇到<code>__init__</code>、<code>__new__</code>、<code>__call__</code>等函数，一直以来，对这三个函数的理解都是模模糊糊，没有去弄清它是怎么工作的。前一段时间，在TG电报上遇到有人在讨论python的descriptor，发现自己并不是很清楚，所以去研究学习了一番，顺便回头对<code>init</code>,<code>new</code>,<code>call</code>重新认识下，形成此文，以作记录。</p> <p><strong>注意</strong>：下面的内容会涉及到descriptor等知识，我只将相关知识的结论提取出来，具体细节未列出。</p> <h2 id="内容"><a href="#内容" aria-hidden="true" class="header-anchor">#</a> 内容</h2> <h3 id="一、-init"><a href="#一、-init" aria-hidden="true" class="header-anchor">#</a> 一、__init__</h3> <p>​	首先可以看官方文档上对<code>__init__</code>的解释。</p> <blockquote><p>object.__init__(self[, ...])</p> <p>Called after the instance has been created (by __new__()), but before it is returned to the caller. The arguments are those passed to the class constructor expression. If a base class has an __init__() method, the derived class’s __init__() method, if any, must explicitly call it to ensure proper initialization of the base class part of the instance;</p> <p>for example: super().__init__([args...]).</p> <p>Because __new__() and __init__() work together in constructing objects (__new__() to create it, and __init__() to customize it), no non-None value may be returned by __init__(); doing so will cause a TypeError to be raised at runtime.</p></blockquote> <p>上面这段解释可以总结为以下几点</p> <ol><li>__init__是个实例方法，以为它的第一个参数是self。</li> <li>__init__在实例被创建后和返回前被调用。</li> <li>__init__的作用的初始化(定制)一个对象(实例)。</li> <li>__init__返回值为None，返回非None会产生运行时错误。</li></ol> <p>所以在使用python类的时候，如果需要对类的实例做初始化，则需要在类中定义init方法。</p> <h3 id="二、-new"><a href="#二、-new" aria-hidden="true" class="header-anchor">#</a> 二、__new__</h3> <p>​	同样的，首先去官方文档上查找对new的解释。</p> <blockquote><p>比较多，摘抄下主要</p> <p>object.__new__(cls[, ...])</p> <p>Called to create a new instance of class cls. __new__() is a static method</p> <p>If __new__() returns an instance of cls, then the new instance’s __init__() method will be invoked like __init__(self[, ...]), where self is the new instance and the remaining arguments are the same as were passed to __new__().</p></blockquote> <p>从以上解释可以明白：</p> <ol><li>__new__的第一个参数是cls，是一个类。</li> <li>__new__是一个静态方法。</li> <li>__new__如果返回一个实例，那么这个实例的__init__方法会被调用。</li></ol> <p>在原来的印象中，函数的第一个参数是cls的基本上都是类方法，但是new并不是类方法，只不过它的第一个参数被设计成了cls。</p> <p>那么为什么new必须是一个static method呢？</p> <p>从new解释中可以看出，new方法返回的实例一定是传入的cls的实例。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">class</span> <span class="token class-name">A</span><span class="token punctuation">:</span>
	<span class="token keyword">pass</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">class</span> <span class="token class-name">B</span><span class="token punctuation">(</span>A<span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token keyword">pass</span>

<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> B<span class="token punctuation">.</span>__new__<span class="token punctuation">(</span>B<span class="token punctuation">)</span>  <span class="token comment"># 因为__new__是静态方法，所以这样调用也可以</span>
<span class="token comment"># 如果cls是B，则实例就是B的实例</span>
<span class="token operator">&lt;</span>__main__<span class="token punctuation">.</span>B <span class="token builtin">object</span> at <span class="token number">0x00000000034351D0</span><span class="token operator">&gt;</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> B<span class="token punctuation">.</span>__new__<span class="token punctuation">(</span>A<span class="token punctuation">)</span>
<span class="token comment"># 如果cls是A，则实例就是A的实例</span>
<span class="token operator">&lt;</span>__main__<span class="token punctuation">.</span>A <span class="token builtin">object</span> at <span class="token number">0x000000000341BF98</span><span class="token operator">&gt;</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>实际使用例子</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment"># 使用new来实现单例模式</span>
<span class="token keyword">class</span> <span class="token class-name">Signle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    _instance <span class="token operator">=</span> <span class="token boolean">None</span>
    <span class="token keyword">def</span> <span class="token function">__new__</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> cls<span class="token punctuation">.</span>_instance <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            <span class="token comment"># 注意这句代码，由于new是静态方法，所以cls还要原原本本的super()的new中</span>
            cls<span class="token punctuation">.</span>_instance <span class="token operator">=</span> <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__new__<span class="token punctuation">(</span>cls<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
        <span class="token keyword">return</span> cls<span class="token punctuation">.</span>_instance
    
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">pass</span>

s1 <span class="token operator">=</span> Signle<span class="token punctuation">(</span><span class="token punctuation">)</span>
s2 <span class="token operator">=</span> Signle<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token builtin">id</span><span class="token punctuation">(</span>s1<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token builtin">id</span><span class="token punctuation">(</span>s2<span class="token punctuation">)</span>
<span class="token comment"># True</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h3 id="三、-call"><a href="#三、-call" aria-hidden="true" class="header-anchor">#</a> 三、__call__</h3> <p>​	继续来看官方解释</p> <blockquote><p>object.__call__(self[, args...])</p> <p>Called when the instance is “called” as a function; if this method is defned, x(arg1, arg2, ...) is a shorthand for x.__call__(arg1, arg2, ...).</p></blockquote> <ol><li>__call__是一个实例方法。</li> <li>__call__是在实例向函数一样使用的时候（也就是ins()这样）被调用。</li> <li>ins(arg1, arg2, ...)实际上就是ins.__call__(arg1, arg2, ...)。</li></ol> <p>总之来说，如果一个类中定义了call方法，那么它的实例ins就可以使用ins()的形式使用。</p> <p>python中的一些魔术方法，定义的很简单，但是用起来却是很方便。</p> <p>下面看一个例子，比较有难度，或者说比较绕。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment"># 这个例子在我查找python单例模式的时候从网上抄来的例子，一直没理解清楚，直到现在才稍微理解了</span>
<span class="token keyword">class</span> <span class="token class-name">Signleton</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    _instance <span class="token operator">=</span> <span class="token boolean">None</span>
    <span class="token keyword">def</span> <span class="token function">__call__</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> cls<span class="token punctuation">.</span>_instance <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            cls<span class="token punctuation">.</span>_instance <span class="token operator">=</span> <span class="token builtin">super</span><span class="token punctuation">(</span>Signleton<span class="token punctuation">,</span> cls<span class="token punctuation">)</span><span class="token punctuation">.</span>__call__<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
        <span class="token keyword">return</span> cls<span class="token punctuation">.</span>_instance

<span class="token keyword">class</span> <span class="token class-name">C</span><span class="token punctuation">(</span>metaclass<span class="token operator">=</span>Signleton<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">pass</span>

c1 <span class="token operator">=</span> C<span class="token punctuation">(</span><span class="token punctuation">)</span>
c2 <span class="token operator">=</span> C<span class="token punctuation">(</span><span class="token punctuation">)</span>
c1 <span class="token keyword">is</span> c2
<span class="token comment"># True</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>先从大致解释下这个程序开始。</p> <p>首先例子中使用了元类(metaclass)，元类简单来说就是类的类，也就是说类是元类的实例。具体解释可以看一篇比较好的解释。</p> <p>https://segmentfault.com/a/1190000011447445</p> <p>可以通过ins.__class__来查看这个实例的类，如果对一个类这样做可以看到类的类是type。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">class</span> <span class="token class-name">A</span><span class="token punctuation">:</span>
	<span class="token keyword">pass</span>

<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> a <span class="token operator">=</span> A<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> a<span class="token punctuation">.</span>__class__
<span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">'__main__.A'</span><span class="token operator">&gt;</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> A<span class="token punctuation">.</span>__class__
<span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">'type'</span><span class="token operator">&gt;</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>有没有好奇为什么一个类可以使用Class()这样的形式调用，那是因为</p> <ol><li>类是元类的实例。</li> <li>如果类中定义了__call__那么它的实例就可以使用ins()的形式。</li></ol> <p>现在可以解释下例子中比较绕的地方。</p> <p>当时看这个这个例子的时候，总感觉有点怪，__call__不是实例方法吗？为什么例子中call的第一个参数是cls。改一下就比较清晰了</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">Signleton</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    _instance <span class="token operator">=</span> <span class="token boolean">None</span>
    <span class="token keyword">def</span> <span class="token function">__call__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>_instance <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>_instance <span class="token operator">=</span> <span class="token builtin">super</span><span class="token punctuation">(</span>Signleton<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__call__<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_instance

<span class="token keyword">class</span> <span class="token class-name">C</span><span class="token punctuation">(</span>metaclass<span class="token operator">=</span>Signleton<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">pass</span>

c1 <span class="token operator">=</span> C<span class="token punctuation">(</span><span class="token punctuation">)</span>
c2 <span class="token operator">=</span> C<span class="token punctuation">(</span><span class="token punctuation">)</span>
c1 <span class="token keyword">is</span> c2
<span class="token comment"># True</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>这样就出现了一个问题，<code>self._instance</code>这样能访问到Signleton中定义的_instance吗？答案是可以。</p> <p>这是因为python的属性搜索<code>__getattribute__(self, name)</code>是按照</p> <ol><li>类属性，包括父类，除了metaclass</li> <li>数据描述符</li> <li>实例属性</li> <li>非数据描述符</li> <li><code>__getattr__(self, name）</code></li></ol> <p><strong>注意</strong>:只总结了结论，具体解释可以看http://www.voidcn.com/article/p-kkkcneuk-bow.html讲的非常清楚。</p> <p>所以上一个步骤中最终找到了非数据描述符，但是它不是function，直接返回值。所以就访问到了_instance。
然后通过<code>if self._instance</code> 发现为None。
然后<code>self._instance</code>就被赋值了，那么赋值后的<code>self._instance</code>和<code>_instance</code>是不是同一个了呢？答案：不是。
原因：实例属性赋值的时候会调用<code>__setattr__(self, name)</code>
搜索顺序：</p> <ol><li>类中寻找属性，如果找到了且是数据描述符，就调用这个属性的__set__方法。如果不是进入下一步。</li> <li>在实例中创建这个属性<code>instance.__dict__[&quot;name&quot;] = xx</code>。</li></ol> <p>根据以上原因，所以<code>self._instance</code>是实例属性，<code>_instance</code>是类属性，两者无关。</p> <p>证据：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> C<span class="token punctuation">.</span>_instance
<span class="token operator">&lt;</span>__main__<span class="token punctuation">.</span>C <span class="token builtin">object</span> at <span class="token number">0x0000000003699978</span><span class="token operator">&gt;</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> Signleton<span class="token punctuation">.</span>_instance
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token comment"># 返回None，所以没有任何打印。</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div></div> <!----> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">7/2/2019, 11:43:53 PM</span></div></footer> <!----> </main> <div class="valine-wrapper" data-v-0162251c><div id="valine" data-v-0162251c></div></div></div> <div class="back-to-ceiling" style="right:1rem;bottom:3rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;background-color:rgba(231, 234, 241,.5);display:none;" data-v-d0bfeaa4 data-v-d0bfeaa4><i class="iconfont reco-up" data-v-d0bfeaa4></i></div></div></div></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.85bff52c.js" defer></script><script src="/assets/js/4.9ee7c604.js" defer></script><script src="/assets/js/1.0b6a70ce.js" defer></script><script src="/assets/js/14.e6cfaa4f.js" defer></script>
  </body>
</html>
